<launch>
    <!-- ============================== PARAMETERS ============================== -->
    <!-- Mode selection: use_rosbag (default: true) switches between rosbag and real camera -->
    <arg name="use_rosbag" default="true" />
    
    <!-- Rosbag file path (required when use_rosbag=true) -->
    <arg name="bag_file" default="" />
    
    <!-- Rosbag playback options -->
    <arg name="bag_loop" default="false" />
    <arg name="bag_rate" default="1.0" />
    <arg name="bag_start" default="0.0" />
    
    <!-- Topic to remap (useful if your bag uses different topic names) -->
    <arg name="input_topic" default="/nerian_stereo/point_cloud" />
    
    <!-- Enable/disable visualization -->
    <arg name="enable_rviz" default="true" />
    <arg name="enable_rqt" default="true" />

    <!-- ============================== ROSBAG PLAYBACK ============================== -->
    <!-- Play rosbag if use_rosbag is true -->
    <group if="$(arg use_rosbag)">
        <node pkg="rosbag" type="play" name="rosbag_player" 
              args="--clock $(arg bag_file) --loop=$(arg bag_loop) --rate=$(arg bag_rate) --start=$(arg bag_start)"
              required="true" output="screen" if="$(eval bag_file != '')"/>
        
        <!-- Warning if no bag file specified -->
        <node pkg="rostopic" type="rostopic" name="bag_warning" 
              args="echo /rosout" output="screen" if="$(eval bag_file == '')">
            <param name="warning" value="WARNING: use_rosbag=true but no bag_file specified! Please provide bag_file:=/path/to/file.bag"/>
        </node>
    </group>

    <!-- ============================== CAMERA DRIVER ============================== -->
    <!-- Launch camera driver if not using rosbag -->
    <!-- Note: You need to add your specific camera driver here -->
    <group unless="$(arg use_rosbag)">
        <!-- TODO: Add your camera driver launch here, for example: -->
        <!-- <include file="$(find nerian_stereo)/launch/nerian_stereo.launch" /> -->
        <node pkg="rostopic" type="rostopic" name="camera_info" 
              args="echo /rosout" output="screen">
            <param name="info" value="Camera mode enabled. Make sure your camera driver is running and publishing to $(arg input_topic)"/>
        </node>
    </group>

    <!-- ============================== PROCESSING NODES ============================== -->
    <!-- LAUNCH THE PREPROCESSING NODE -->
    <node name="preprocessing_node" type="preprocessing_node" pkg="ugoe_gap_detection_ros" output="screen">
        <!-- Remap input topic if needed -->
        <remap from="/nerian_stereo/point_cloud" to="$(arg input_topic)" />
    </node>

    <!-- LAUNCH THE GAP DETECTOR NODE -->
    <node name="ugoe_gap_detection_ros" type="gap_detector.py" pkg="ugoe_gap_detection_ros" output="screen"/>

    <!-- ============================== VISUALIZATION ============================== -->
    <!-- LAUNCH RVIZ -->
    <node type="rviz" name="rviz" pkg="rviz" 
          args="-d $(find ugoe_gap_detection_ros)/rviz_config.rviz" 
          if="$(arg enable_rviz)"/>
    
    <!-- START DYNAMIC RECONFIGURE -->
    <node name="rqt_gui" pkg="rqt_gui" type="rqt_gui" 
          args="-s reconfigure" 
          if="$(arg enable_rqt)"/>
</launch>



